<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>local ip</title>
</head>
<body>
<pre id="data"></pre>
<script>
const findLocalIp = (logInfo = true) => new Promise( (resolve, reject) => {
    window.RTCPeerConnection = window.RTCPeerConnection
        || window.mozRTCPeerConnection
        || window.webkitRTCPeerConnection;

    if ( typeof window.RTCPeerConnection == 'undefined' )
        return reject('WebRTC not supported by browser');

    let rtcPeerConx = new RTCPeerConnection();
    let ips = [];

    rtcPeerConx.createDataChannel("");
    rtcPeerConx.createOffer()
        .then(offer => rtcPeerConx.setLocalDescription(offer))
        .catch(err => reject(err));
    /*
    * ICE = Interactive Connectivity Establishment.
    * Los candidatos ICE son direcciones utilizadas para establecer una conexión P2P entre dos dispositivos.
    * Cuando se activa el evento onicecandidate, se proporciona un objeto event que contiene la información del candidato ICE.
    * */
    rtcPeerConx.onicecandidate = event => {
        if ( !event || !event.candidate ) {
            // All ICE candidates have been sent.
            if ( ips.length == 0 )
                return reject('WebRTC disabled or restricted by browser');

            return resolve(ips);
        }

        let parts = event.candidate.candidate.split(' ');
        let [base,componentId,protocol,priority,ip,port,,type,...attr] = parts;
        let component = ['rtp', 'rtpc'];

        if ( ! ips.some(e => e == ip) )
            ips.push(ip);

        if ( ! logInfo )
            return;

        const r = {
            candidate: base.split(':')[1],
            component: component[componentId - 1],
            protocol,
            priority,
            ip,
            port,
            type,
            attributes: {},
            full_parts: parts,
        }

        if ( attr.length ) {
            console.log("attr", attr)
            for(let i = 0; i < attr.length; i += 2)
                r.attributes[attr[i]] = attr[i+1]
        }
        document.getElementById("data").innerText = JSON.stringify(r, null, 4)
    };
} );
findLocalIp()
</script>
</body>
</html>